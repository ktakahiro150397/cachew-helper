# Cachew Helper 仕様書

## 統合シートとCashew出力シートの相違点について

### フィルタリング条件

統合シート（④作業_統合データ）に表示されるデータが、Cashew出力シート（⑤出力_Cashew用）に表示されない主な理由は以下の通りです：

1. **日付によるフィルタリング**
   - `formatForCashew.ts`内で、日付が2025年4月1日より前のデータは出力対象から除外されています
   - 実装コード: 
     ```typescript
     const DATA_DATE_START_THRESHOLD = new Date("2025-04-01");
     
     // 指定日時より前のデータは無視する
     if (date < DATA_DATE_START_THRESHOLD) {
       continue;
     }
     ```
   - このフィルタリングは、古いデータを除外することで最新の取引のみをCashewに出力するための仕組みです

2. **振替取引の特別処理**
   - 振替取引（`sourceAccount`と`destinationAccount`の両方が設定されている取引）は、カテゴリが「振替」に変換され、特別な処理が行われます
   - 振替元と振替先の両方でレコードが作成されるため、表示方法が通常の取引と異なる可能性があります
   - 振替取引の振替先レコードでは金額が反転（負の値）されます

3. **カテゴリの自動変換**
   - 統合シートのカテゴリと、Cashew出力シートのカテゴリは必ずしも一致しません
   - `getCategoryFromCashewData`関数により、取引の摘要（description）の内容に基づいてカテゴリが再設定されます
   - 例えば、摘要に特定のキーワード（「マルハチ」など）が含まれていると、自動的に対応するカテゴリ（「食費・日用品」など）に分類されます

### データの変換プロセス

統合シートのデータがCashew出力シートに変換される過程は以下の通りです：

1. `process-transaction.ts`内の`processTransaction`関数で統合データの全行が取得されます
2. 取得したデータは`formatForCashew`関数に渡され、Cashewのインポート形式に変換されます
3. 変換処理中に上記のフィルタリングや特別処理が適用されます
4. 最終的に変換されたデータが⑤出力_Cashew用シートに出力されます

### 注意事項

- 現在の実装では、2025年4月1日より前のデータは常に除外されます。これは、現在日付（2025年7月1日）から見て直近の3ヶ月程度のデータのみを処理対象としているためです
- 必要に応じて、`DATA_DATE_START_THRESHOLD`の値を変更することでフィルタリング期間を調整できます
- 特定のカテゴリや取引種別の処理方法は、`getCategoryFromCashewData`や`formatForCashew`関数内で定義されています

### 今後の改善案

- フィルタリング期間を設定で変更できるようにする
- 統合シートとCashew出力シートのカテゴリマッピングをより柔軟に設定できるようにする
- 振替取引の処理方法についてよりわかりやすいドキュメントを提供する
