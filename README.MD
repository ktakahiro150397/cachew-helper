# Cashew 家計簿管理システム - Google Apps Script モジュール

このリポジトリは、Google Apps Script (GAS) を使用して、様々なデータソース（銀行口座CSV、クレジットカードCSV、レシートOCRデータ）を統合・整形し、Cashew家計簿アプリに取り込むためのCSVファイルを生成するモジュールを格納しています。

Cashewシステム全体の目的は、「無駄遣いを減らす」ことと「漠然としたお金の不安をなくす」こと、そしてその達成のために「入力作業を可能な限り自動化し、いつでも最新のキャッシュフロー（お金の流れ）を正確に把握できる状態にする」ことです。

## TODO

- SBI銀行取り込み対応
- エクスポートデータを別シートに退避して取り込み済み警告を追加

## 開発・デプロイ方法

### 環境構築
1. Node.js がインストールされていることを確認してください
2. 依存関係をインストールします：
   ```bash
   npm install
   ```

### ビルドとデプロイ
本プロジェクトはTypeScriptで記述されており、Google Apps Scriptにデプロイするためには以下の手順を実行します：

1. **ビルド**: TypeScriptをJavaScriptにコンパイルし、GAS向けにバンドルします
   ```bash
   npm run build
   ```

2. **デプロイ**: clasp pushを使ってGoogle Apps Scriptプロジェクトにコードをアップロードします
   ```bash
   npm run deploy
   ```
   このコマンドは `npm run build && npm run push` を実行し、ビルドとデプロイを一度に行います。

### その他のコマンド
- `npm run push`: ビルド済みのファイルをGASにプッシュ
- `npm run open`: GASエディタをブラウザで開く

### 注意事項
- デプロイする前に `.clasp.json` ファイルが適切に設定されていることを確認してください
- GASプロジェクトのスクリプトIDが正しく設定されている必要があります

## プロジェクト構成

本プロジェクトは以下のような構成になっています：

```
├── src/                           # TypeScriptソースコード
│   ├── main.ts                   # エントリポイント（GAS関数をグローバルに公開）
│   ├── sample.ts                 # サンプル関数
│   ├── core/                     # コア機能モジュール
│   │   ├── bank/                # 銀行データ処理
│   │   │   └── processBankData.ts
│   │   ├── card/                # カードデータ処理
│   │   │   ├── processCardData.ts
│   │   │   └── determineCardTypeFromDescription.ts
│   │   ├── cashew/              # Cashew形式変換
│   │   │   └── formatForCashew.ts
│   │   ├── receipt/             # レシートデータ処理
│   │   │   ├── processReceiptData.ts
│   │   │   └── createReceiptTotalsMap.ts
│   │   └── util/                # ユーティリティ
│   │       └── dateformat.ts
│   ├── enum/                    # 列挙型定義
│   │   ├── cashew-account.ts
│   │   └── cashew-category.ts
│   ├── interface/               # インターフェース定義
│   │   └── cashew-export.ts
│   ├── handler/                 # メイン処理ハンドラー
│   │   └── process-transaction.ts
│   └── sheetoperation/          # スプレッドシート操作
│       └── sheet-operation.ts
├── dist/                        # ビルド出力先（GASにデプロイされるJavaScript）
├── package.json                 # npm設定とスクリプト
├── tsconfig.json               # TypeScript設定
├── esbuild.js                  # ビルド設定
├── .clasp.json                 # Google Apps Script CLI設定
└── README.MD                   # このファイル
```

### 主要な処理関数

本システムでは以下の関数がGAS上で利用可能です：

- **`processTransaction()`**: メイン処理関数。全データソースを統合してCashew形式で出力
- **`createReceiptTotalsMap()`**: レシートデータから合計金額マップを作成
- **`processCardData()`**: カード明細を処理し、レシートとの重複を除去
- **`processBankData()`**: 銀行明細を処理し、取引種別を判定
- **`processReceiptData()`**: レシートデータを統合データに追加
- **`formatForCashew()`**: 統合データをCashew形式に変換
- **`formatDate()`**: 日付フォーマット統一のユーティリティ関数
- **`determineCardTypeFromDescription()`**: 摘要からカード種別を推測

## 1. システム全体像における本GASモジュールの役割

Cashew家計簿管理システムは、複数のデータソースから取引情報を収集し、**Googleスプレッドシート**と**Google Apps Script (GAS)**を利用して統合・整形を行います。本GASモジュールは、この「データ処理・統合」の中核を担います。

具体的には、以下のプロセスを実行します。

1.  **データ収集:** 銀行口座CSV、クレジットカードCSV、**レシートOCRアプリ**からエクスポートされたCSVデータをGoogleスプレッドシートに貼り付けます。
2.  **データ処理・統合:** スプレッドシート上の生データを読み込み、名寄せを行いながら「支出」「収入」「振替」を正確に区別して一つの統合データを作成します。
3.  **データ出力:** 最終的にCashew家計簿アプリが読み込める形式のCSVファイルを生成します。

このモジュールの重要な役割の一つは、**クレジットカード明細とレシートOCRデータを照合し、二重計上を防止する**自動処理を行うことです。

## 2. 満たすべきシステム要件とデータソース

Cashewシステムは以下の要件を満たすことを目指しています。

*   **入力の自動化・省力化:** 手間をなくし、継続性を担保する。
*   **二重計上の完全な防止:** キャッシュフローの正確性を担保する。
*   複数口座の資金追跡: 個人と家族の口座を一元管理する。
*   柔軟なデータ管理: 特定のアプリに縛られず、データを自分で所有・管理できる。
*   直感的なデータ可視化: 最終的に家計簿アプリでグラフなどで分かりやすく把握できる。
*   **低コストでの実現:** 無料ツールやOSSを最大限活用する。

これらの要件を満たすために、以下のデータソースを活用します。

*   **銀行口座CSV:** クレジットカード以外のすべての現金の動きを把握します（収入、口座振替、現金引き出し、口座間移動など）。
*   **クレジットカードCSV:** カードで支払ったすべての支出明細を把握します（店舗での買い物、ネットショッピング、カード払いのサブスクなど）。
*   **レシートOCRデータ:** **カードや現金払いの支出を品目レベルまで詳細化**し、「**支払方法**」を記録します。

### 2.1. レシートOCRデータに対する必須要件

本GASモジュールによる自動処理、特に二重計上防止ロジックは、レシートOCRデータに大きく依存しています。したがって、使用するレシートOCRアプリには以下の要件が必須となります。

*   **スマートフォンでの手軽な利用:** アプリはスマートフォンで利用できる必要があります。
*   **品目レベルでの詳細キャプチャ:** 個々の購入品目まで認識できる能力が求められます。
*   **明確な「支払方法」の記録とエクスポート:**
    *   レシートごとに**「支払方法」（例：個人カード、家族現金）**をユーザーが指定した通りに記録できること。
    *   この「支払方法」情報が、**CSVファイル内で独立した列として明確に出力される**こと。GASスクリプトは、この特定の列のデータに基づいてカード明細との照合を行うため、この要件は**システム連携における合否を分ける基準**となります。
*   **一般的なCSVエクスポート機能:** Googleスプレッドシートの特定シートにインポートするために、データをCSV形式でエクスポートできること。
*   **低コストでの実現:** システム全体が低コストを目指しているため、アプリも無料または安価な個人向けプランである必要があります。高機能だが高価な法人向けOCRサービス（例：スマートOCR、CLOVA OCRなど）はCashewシステムの思想と矛盾します。

## 3. Google Apps Script の処理内容

本モジュールは、Googleスプレッドシート上に以下の5つのシートを前提として動作します。

*   **①入力_銀行:** 各銀行からダウンロードしたCSVを貼り付けるシート。
*   **②入力_カード:** 各カード会社からダウンロードしたCSVを貼り付けるシート。
*   **③入力_レシート:** レシートOCRアプリからエクスポートしたCSVを貼り付けるシート。**「支払方法」（例：個人カード, 家族現金）の列が必須**です。
*   **④作業_統合データ:** 全ての取引データを処理・統合後、一時的に格納するシート.
*   **⑤出力_Cashew用:** Cashewアプリにインポートするための最終的な形式に整えられたデータが出力されるシート.

GASスクリプトは、スプレッドシート上の「実行ボタン」などからトリガーされることを想定しており、以下の処理を順番に実行します。

1.  **初期化処理:** `④作業_統合データ` と `⑤出力_Cashew用` シートの内容をクリアします。
2.  **レシートデータの前処理:** `③入力_レシート` のデータを読み込み、**カード払いのレシート**を対象に「**同じ日付**」「**同じ支払方法**」でグループ化し、支払いの**合計金額を計算**したマップ（対応表）を作成します。
3.  **カード明細の処理:** `②入力_カード` のデータを1行ずつ読み込み、手順2で作成したレシート合計金額マップに**一致するデータがあるか照合**します。
    *   **一致した場合（レシートあり）：** このカード明細行は**無視**します。これは、レシートデータで既に詳細（品目レベル）が記録されているため、カード明細側は不要と判断するためです。**これが二重計上防止の仕組みです**。
    *   **一致しない場合（レシートなし）：** このカード明細行を、取引種別**「支出」**として`④作業_統合データ`にコピーします。
4.  **銀行明細の処理:** `①入力_銀行` のデータを1行ずつ読み込み、明細の内容から取引種別（支出, 収入, 振替）を判定し、`④作業_統合データ`にコピーします.
5.  **レシートデータの処理:** `③入力_レシート`の全データを`④作業_統合データ`にコピーします。各行は取引種別**「支出」**として扱います.
6.  **最終データへの整形・出力:** `④作業_統合データ`の全データを、Cashewアプリのインポート仕様に合わせて整形し、`⑤出力_Cashew用`シートに書き出します.

**重要な点:** 上記ステップ3のカード明細とレシートの照合は、レシートデータに**正確な「支払方法」情報**が含まれていることが前提となります。この情報が欠落しているか不正確だと、照合が正しく行われず、支出の見逃しまたは二重計場が発生する可能性があります。

## 4. レシートOCRアプリの検討状況（抜粋）

前述の必須要件、特に「支払方法」の記録とCSVでの個別エクスポートという点に着目し、いくつかのスマートフォン向けレシートOCRアプリが調査・評価されています。

多くのアプリは銀行口座やクレジットカードとの直接連携を通じて支払情報を取得する方式を主としており、これはレシートOCRの段階で手動または選択式で「支払方法」を記録し、その情報を基に後続処理を行うCashewシステムの思想とは必ずしも合致しません。

現時点での調査に基づくと、**株式会社Zaimが提供する家計簿アプリ「Zaim」**が、その**「内訳」機能**の活用により、Cashewシステムの要求する「支払方法」の記録・エクスポートに**最も対応できる可能性が高い**と評価されています。ZaimはOCR精度やCSVエクスポート機能も概ね良好とされています。

しかし、**Zaimの「内訳」機能で記録した情報が、CSVエクスポート時にCashewシステムのGASが読み取り可能な「支払方法」列として独立して出力されるか**については、ユーザー自身による**実際の検証が必要**です。公式なCSV仕様書だけでは明確に判断できないためです。

マネーフォワード MEも有力な家計簿アプリですが、レシートOCR入力時点で手動で支払方法を指定し、それをCSVで個別出力できるかについては、提供された情報からはZaimほど明確ではありません。

高機能な法人向けOCRサービス（スマートOCRなど）は、その価格から「低コストでの実現」という要件を満たさないためCashewシステムには不向きです。

## 5. 将来的な検討事項：Gemini APIの活用可能性

将来的に、レシートOCRアプリへの依存度を減らし、レシート処理の自動化・精度・柔軟性をさらに向上させる選択肢として、Googleの提供する**Gemini Vision APIの活用**が検討されています。

Geminiは画像とテキストを統合的に理解するマルチモーダルAIであり、プロンプトと**JSONスキーマ**を用いることで、レシート画像から「店名、日付、合計金額、品目リスト」、そして**「支払方法」といった指定した情報を構造化されたJSON形式で直接抽出**する能力を有しています。

これをGASと連携させることで、レシート画像をシステムに提供するだけで、自動的にGeminiが解析し、結果をスプレッドシートに書き出すワークフローが構築できる可能性があります。これは現在のOCRアプリを用いたフローと比較して、データ収集の手間を大幅に削減し、自動化レベルを向上させる潜在性があります.また、特定の情報（支払方法など）を確実に抽出するための柔軟性や、多様なレシート形式への対応力、品目レベルの精度向上も期待されます.

一方で、Gemini APIの利用にはコストが発生するため、「低コストでの実現」という要件とのバランスを考慮する必要があります。モデルの選択（例：コスト効率の良いGemini 1.5 Flash）、プロンプトとスキーマ設計、そしてAPI呼び出しエラーや誤解析に対するエラーハンドリング が実装上の重要な課題となります。

現時点ではOCRアプリを用いたフローが前提ですが、Gemini APIは将来的な有力な代替手段または補強手段として位置づけられています。

## 6. Cashew 家計簿アプリについて

本システムは、最終的に Cashew という家計簿アプリへのデータインポートを目指しています. CashewアプリはFlutter製で、Firebaseをバックエンドに利用しており、以下の主要な機能を提供しています:

*   予算管理（カスタム予算、カテゴリごとの制限、過去履歴表示）
*   取引管理（多様な取引タイプ、カスタムカテゴリ、検索・フィルター、容易な編集）
*   複数通貨・アカウント（口座）の管理
*   CSVファイルおよびGoogle Sheetsからのデータインポート機能
*   Biometric Lock、Googleログインなどのセキュリティ機能
*   クロスデバイス同期、Google Driveバックアップ

このCashewアプリのCSVインポート機能があるため、本GASモジュールで複数のデータソースを統合・整形した最終データをCashew形式で出力するというワークフローが成り立っています.

## 7. 利用方法

### 事前準備
1. Googleアカウントを用意します。
2. 上記のシート構成（`①入力_銀行`、`②入力_カード`、`③入力_レシート`、`④作業_統合データ`、`⑤出力_Cashew用`）を持つGoogleスプレッドシートを作成します。
3. 本プロジェクトをクローンし、必要に応じて設定を調整します。
4. `npm run deploy` を実行してGoogle Apps Scriptプロジェクトにコードをデプロイします。

### データ処理の実行
1. 要件を満たすレシートOCRアプリ（**「支払方法」を記録・CSV個別エクスポートできるもの**）を選定し、導入します。
2. 各データソースからCSVデータをダウンロードし、それぞれの入力シートに貼り付けます：
   - `①入力_銀行`: 銀行明細CSV
   - `②入力_カード`: クレジットカード明細CSV  
   - `③入力_レシート`: レシートOCRアプリからのCSV
3. レシートOCRアプリでレシートを撮影し、「支払方法」を設定した上でCSVデータをエクスポートし、`③入力_レシート`シートに貼り付けます。**特にカード払いレシートの場合、「支払方法」を正しく設定することが二重計上防止に不可欠です**。
4. GASスクリプトのメイン関数 `processTransaction()` を実行します。スプレッドシート上にボタンを配置して紐付けると便利です。
5. `⑤出力_Cashew用`シートに生成されたCSV形式のデータを、Cashewアプリにインポートします。

### 処理の流れ
`processTransaction()` 関数は以下の順序で処理を実行します：

1. **初期化**: 作業用シートと出力シートをクリア
2. **レシート前処理**: `createReceiptTotalsMap()` でカード払いレシートの合計マップを作成
3. **カード明細処理**: `processCardData()` でレシートとの重複チェック・除去
4. **銀行明細処理**: `processBankData()` で取引種別の判定・分類
5. **レシートデータ処理**: `processReceiptData()` で全レシートデータを統合
6. **最終出力**: `formatForCashew()` でCashew形式に変換・出力

詳細は、各関数内のコメントを参照してください。

## 8. 開発・保守について

### 開発環境
- **言語**: TypeScript
- **ビルドツール**: esbuild + esbuild-gas-plugin
- **デプロイツール**: Google Apps Script CLI (clasp)
- **パッケージ管理**: npm

### コード構成の特徴
- モジュール化された設計により、各データソースの処理ロジックが独立
- TypeScriptによる型安全性の確保
- 単一のエントリポイント（`main.ts`）からすべての関数をGASグローバル空間に公開
- 関数型プログラミングのアプローチを採用し、副作用を最小限に抑制

### 保守・注意点

#### 外部依存関係のリスク
*   **外部データソースの仕様変更リスク:** 銀行、カード会社、そして特にレシートOCRアプリがCSVエクスポートの形式を変更した場合、対応する処理関数（`processBankData`, `processCardData`, `processReceiptData`）の修正が必要となる可能性があります。
*   **レシートOCRアプリの選定:** 「支払方法」の記録とCSV個別エクスポートは必須要件です。選定したアプリがこの要件を本当に満たすか、**小規模な実証テスト（CSVエクスポート結果の確認）を強く推奨**します。

#### 技術的な注意点
*   **TypeScriptからJavaScriptへの変換**: `esbuild.js` の設定変更により、出力されるJavaScriptが期待と異なる場合があります。
*   **GAS固有の制約**: Google Apps Scriptの実行時間制限（6分）やメモリ制限に注意が必要です。大量データ処理時は分割実行を検討してください。
*   **clasp設定**: `.clasp.json` のスクリプトIDが正しく設定されていることを確認してください。

#### 将来的な拡張について
*   **Gemini APIの利用**: 将来的にGemini APIを導入する場合、APIキーの安全な管理、利用コストの監視、およびプロンプト・スキーマの継続的な最適化が必要となります。
*   **新しいデータソースの追加**: 新しいデータソースを追加する場合は、`core/` ディレクトリ下に専用モジュールを作成し、`main.ts` でグローバル関数として公開してください。

これらの点に留意しながら運用することで、本システムを継続的かつ正確に利用することができます。
